<!doctype html>
<html lang="en">

<head>
  <title>Weather Generator</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.9/css/weather-icons-wind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.9/css/weather-icons.min.css">
  <link href="https://fonts.googleapis.com/css?family=Alegreya" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <script src="weather.js"></script>
  <script src="weather-items.js"></script>
  <script src="ogl-data.js"></script>
  <script src="pfwg.js"></script>
  <script>
    var tooltipOptions = {};

    var buildTile = function buildTile(p) {

      var $time;
      if (p.hasOwnProperty('start') && p.hasOwnProperty('duration')) {
        $time = $('<span>', {
          class: 'precipitation-time',
          text: p.start.toAmPmString() + ' - ' + (p.start + p.duration).toAmPmString()
        });
      }

      return $('<div>', {
        class: 'wi ' + p.form.class,
        'data-toggle': 'tooltip',
        'data-placement': 'right',
        title: p.form.text,
        'data-precipitation': p.form.name
      }).append($time);
    };

    var readValues = function readValues() {

      var input = {
        climate: $('#select-climate').val(),
        elevation: $('#select-elevation').val(),
        season: $('#select-season').val(),
      };

      var result = generateWeather(input);

      // display elevation rules
      if (altitudeTexts.hasOwnProperty(input.elevation)) {
        $('#altitude-effects').html(altitudeTexts[input.elevation]);
      }

      console.info(result);

      $('#result-temperature-f').text(result.temperature);
      $('#result-temperature-c').text(result.temperature.convertToCelsius());
      $('#result-night-f').text(result.temperatureNight);
      $('#result-night-c').text(result.temperatureNight.convertToCelsius());
      $('#result-wind').text(result.wind.form.speed);
      $('#result-wind-direction').attr('class', 'wi wi-wind wi-towards-' + result.wind.direction);
      $('#result-clouds').text(result.cloud.form.name);

      $('#weather-effects').empty();

      // checkif precipitation has in-game effects
      if (result.hasOwnProperty('precipitation')) {

        var $tiles = result.precipitation.map(p => buildTile(p));

        $tiles.forEach($t => $t.tooltip());

        if ($tiles.filter($t => $t.data('precipitation').indexOf('fog') > 0).length > 0) {
          $('#weather-effects').prepend($('<header>', {
            html: precipitationTexts.allFog
          }));
        }

        $('#weather-effects').append($tiles);
      }

      // check if temperature has in-game effects
      var displayColdWarning = false,
        displayHeatWarning = false;
      if (result.hasOwnProperty('temperature')) {
        if (result.temperature <= -20) {

          displayColdWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-snowflake-cold heavy',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: coldTemperatureTexts.extremeCold
            }).tooltip());
        } else if (result.temperature <= 0) {

          displayColdWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-snowflake-cold medium',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: coldTemperatureTexts.severeCold
            }).tooltip());
        } else if (result.temperature <= 40) {

          displayColdWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-snowflake-cold light',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: coldTemperatureTexts.veryCold
            }).tooltip());
        } else if (result.temperature >= 90) {

          displayHeatWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-hot light',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: hotTemperatureTexts.veryHot
            }).tooltip());
        } else if (result.temperature >= 110) {

          displayHeatWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-hot medium',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: hotTemperatureTexts.severeHot
            }).tooltip());
        } else if (result.temperature >= 140) {

          displayHeatWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-hot heavy',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: hotTemperatureTexts.extremeHot
            }).tooltip());
        }
      }

      // check if night is meaningfully colder than day
      if (result.hasOwnProperty('temperature') && result.hasOwnProperty('temperatureNight')) {
        if (result.temperatureNight <= -20 && result.temperature > 20) {

          displayColdWarning = true;

          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-night-clear heavy',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: coldTemperatureTexts.extremeCold
            }).tooltip());
        } else if (result.temperatureNight <= 0 && result.temperature > 0) {
          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-night-clear medium',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: coldTemperatureTexts.severeCold
            }).tooltip());
        } else if (result.temperatureNight <= 40 && result.temperature > 40) {
          $('#weather-effects')
            .append($('<div>', {
              class: 'wi wi-night-clear light',
              'data-toggle': 'tooltip',
              'data-placement': 'right',
              title: coldTemperatureTexts.veryCold
            }).tooltip());
        }
      }

      if (displayColdWarning === true) {
        $('#weather-effects').prepend($('<header>', {
          html: coldTemperatureTexts.all
        }));
      } else if (displayHeatWarning === true) {
        $('#weather-effects').prepend($('<header>', {
          html: hotTemperatureTexts.all
        }));
      }

      // check if wind has in-game effects
      if (result.hasOwnProperty('wind') && result.wind.form.beaufortScale > 5) {

        // TODO: handle windstorms
        $('#weather-effects').prepend($('<header>', {
          html: windTexts.all
        }));

        $('#weather-effects')
          .append($('<div>', {
            class: 'wi wi-wind-beaufort-' + result.wind.form.beaufortScale,
            'data-toggle': 'tooltip',
            'data-placement': 'right',
          }).tooltip({
            html: true,
            title: '<b>' + result.wind.form.name + '</b>' +
              '<ul class="wind-effects"><li>ranged attacks: ' + result.wind.form.penaltyRanged +
              '</li><li>siege attacks: ' + result.wind.form.penaltySiege +
              '</li><li>skills: ' + result.wind.form.penaltySkill +
              '</li><li>checkSize: ' + result.wind.form.checkSize +
              '</li><li>blownAwaySize: ' + result.wind.form.blownAwaySize + '</li></ul>'
          }));
      }

      // default display
      if ($('#weather-effects *').length === 0) {
        $('#weather-effects').append($('<h2>', {
          text: 'None'
        }));
      }
    };
  </script>
</head>

<body>
  <h1 class="text-center">Pathfinder Weather Generator</h1>

  <div class="row">
    <div class="col-sm-6 text-right">
      <section id="input" class="text-left">
        <h1>Your climate:</h1>
        <label for="select-climate">Climate:</label>
        <select id="select-climate">
          <option value="cold">cold</option>
          <option value="temperate" selected="selected">temperate</option>
          <option value="tropical">tropical</option>
        </select>
        <br/>
        <label for="select-elevation">Elevation:</label>
        <select id="select-elevation">
          <option value="seaLevel">sea level</option>
          <option value="lowland" selected="selected">lowland</option>
          <option value="highland">highland (5,000 ft)</option>
          <option value="highpeak">above 15,000 ft</option>
        </select>
        <br/>
        <label for="select-season">Season:</label>
        <select id="select-season">
          <option value="winter">winter</option>
          <option value="spring" selected="selected">spring</option>
          <option value="summer">summer</option>
          <option value="fall">fall</option>
        </select>
        <button onclick="readValues()">GO</button>
      </section>
    </div>
    <div class="col-sm-6">
      <section id="output">
        <h1>Outlining:</h1>
        <article>
          <label>Temperature:</label>
          <span id="result-temperature-f"></span>째F /
          <span id="result-temperature-c"></span>째C
        </article>
        <article>
          <label>At night:</label>
          <span id="result-night-f"></span>째F /
          <span id="result-night-c"></span>째C
        </article>
        <article>
          <label>Wind:</label>
          <span id="result-wind"></span>
          <i id="result-wind-direction" class="wi"></i>
        </article>
        <article>
          <label>Clouds:</label>
          <span id="result-clouds"></span>
        </article>
      </section>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <section id="effects">
        <h1>In-game effects:</h1>
        <header id="altitude-effects"></header>
        <div id="weather-effects" class="picto-list">

        </div>
      </section>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <section>
        <h4>Possible weather events
          <button onclick="$('#list-effects').toggleClass('hidden')">show/hide</button>
        </h4>
        <div id="list-effects" class="picto-list hidden">

        </div>
      </section>
    </div>
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script>
    var $listTiles = Object.keys(precipitationForms).map(key =>
      $('<div>', {
        class: 'wi ' + precipitationForms[key].class,
        'data-toggle': 'tooltip',
        'data-placement': 'right',
        title: precipitationForms[key].text
      }));
    $listTiles.forEach($t => $t.tooltip());
    $('#list-effects').append($listTiles);
  </script>
</body>

</html>